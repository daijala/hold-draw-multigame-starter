
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hold & Draw Multi-Game Test Client</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; max-width: 920px; margin: 2rem auto; padding: 0 1rem; }
    fieldset { margin-bottom: 1rem; }
    input, button { font-size: 1rem; padding: 0.4rem 0.6rem; }
    .row { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
    #log { background: #111; color: #eee; padding: 1rem; height: 320px; overflow: auto; }
    code { background: #f3f3f3; padding: 0.1rem 0.25rem; border-radius: 4px; }
    .pill { display:inline-block; padding: 0.2rem 0.5rem; border-radius: 9999px; background:#f0f0f0; margin-right: 0.25rem; }
  </style>
</head>
<body>
  <h1>Hold & Draw ‚Ä¢ Multi‚ÄëGame Test Client</h1>
  <p>Point this at your Socket.io server (default <code>http://localhost:8000</code>).</p>

  <fieldset>
    <legend>Connection</legend>
    <div class="row">
      <label>Server URL
        <input id="serverUrl" value="http://localhost:8000" size="28" />
      </label>
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn">Disconnect</button>
      <span id="connState">Disconnected</span>
    </div>
  </fieldset>

  <fieldset>
    <legend>Game Controls</legend>
    <div class="row">
      <label>Game ID <input id="gameId" placeholder="(create or join)" size="18"/></label>
      <label>Player Name <input id="playerName" value="Player_1" size="14"/></label>
    </div>
    <div class="row">
      <button id="createGameBtn">Create Game</button>
      <button id="joinGameBtn">Join Game</button>
      <button id="leaveGameBtn">Leave Game</button>
      <button id="startGameBtn">Start Game (Host)</button>
      <button id="requestStateBtn">Request State</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Round Actions</legend>
    <div class="row">
      <label>Round <input id="round" type="number" min="1" value="1" style="width:5rem"/></label>
      <label>Score <input id="score" type="number" min="0" value="100" style="width:7rem"/></label>
      <button id="submitScoreBtn">Submit Score</button>
    </div>
  </fieldset>

  <fieldset>
    <legend>Live Game State</legend>
    <div id="state"></div>
  </fieldset>

  <h3>Log</h3>
  <pre id="log"></pre>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const $ = id => document.getElementById(id);
    let socket = null;

    async function loadBackendUrl() {
      try {
        const response = await fetch('/api/config');
        const config = await response.json();
        $("serverUrl").value = config.backendUrl;
      } catch (error) {
        console.error('Failed to load backend URL, using default:', error);
        $("serverUrl").value = 'http://localhost:8000';
      }
    }
    
    loadBackendUrl();

    function log(...args) {
      const s = args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ');
      const el = $("log");
      el.textContent += s + "\n";
      el.scrollTop = el.scrollHeight;
      console.log(...args);
    }

    function renderState(gs) {
      if (!gs) { $("state").innerHTML = ""; return; }
      $("round").value = gs.round > 0 && gs.round <= gs.maxRounds ? gs.round : gs.maxRounds;
      const players = gs.players.map(p => 
        `<span class="pill">${p.connected ? "üü¢" : "‚ö´Ô∏è"} ${p.name} (last: ${p.lastSubmitRound})</span>`
      ).join(" ");
      const awaiting = gs.awaiting?.length ? gs.awaiting.join(", ") : "none";

      $("state").innerHTML = `
        <div><strong>Game:</strong> ${gs.gameId}</div>
        <div><strong>Host:</strong> ${gs.hostName}</div>
        <div><strong>Round:</strong> ${gs.round} / ${gs.maxRounds} ${gs.round > gs.maxRounds ? " ‚Äî <strong>Game Over</strong>" : ""}</div>
        <div><strong>Awaiting:</strong> ${awaiting}</div>
        <div><strong>Players:</strong> ${players}</div>
      `;
    }

    function connect() {
      const url = $("serverUrl").value.trim();
      if (!url) return alert("Enter server URL");
      socket = io(url, { transports: ["websocket"] });
      $("connState").textContent = "Connecting...";
      socket.on("connect", () => { $("connState").textContent = "Connected"; log("‚úÖ connected", socket.id); });
      socket.on("disconnect", () => { $("connState").textContent = "Disconnected"; log("‚ùå disconnected"); });
      socket.on("stateUpdate", (gs) => { log("stateUpdate", gs); renderState(gs); });
      socket.on("error", (e) => { log("server error", e); alert(e.message || "Server error"); });
    }

    function disconnect() {
      if (socket) socket.disconnect();
      socket = null;
    }

    $("connectBtn").onclick = connect;
    $("disconnectBtn").onclick = disconnect;

    $("createGameBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const hostName = $("playerName").value.trim() || "Host";
      const desiredId = $("gameId").value.trim();
      socket.emit("createGame", { hostName, gameId: desiredId || undefined });
    };

    $("joinGameBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const gameId = $("gameId").value.trim();
      const playerName = $("playerName").value.trim();
      if (!gameId || !playerName) return alert("Enter gameId and playerName");
      socket.emit("joinGame", { gameId, playerName });
    };

    $("leaveGameBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const gameId = $("gameId").value.trim();
      const playerName = $("playerName").value.trim();
      socket.emit("leaveGame", { gameId, playerName });
    };

    $("startGameBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const gameId = $("gameId").value.trim();
      socket.emit("startGame", { gameId });
    };

    $("submitScoreBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const gameId = $("gameId").value.trim();
      const playerName = $("playerName").value.trim();
      const round = parseInt($("round").value, 10);
      const score = parseInt($("score").value, 10);
      socket.emit("submitScore", { gameId, playerName, round, score });
    };

    $("requestStateBtn").onclick = () => {
      if (!socket) return alert("Connect first");
      const gameId = $("gameId").value.trim();
      socket.emit("requestState", { gameId });
    };
  </script>
</body>
</html>
